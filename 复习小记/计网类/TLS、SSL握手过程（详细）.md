## TLS/SSL握手过程（详细）

### 1.选择TLS的原因：

HTTP是明文传输的，在方便消息可读的同时，也意味着我们信息的暴露，那么一旦我们的某些重要信息被截取那么就会产生很严重的安全问题。这也是为什么会选择TLS来进行安全措施。

1.窃听风险，通信链路上可以截获通信内容，用户账号可能没

2.篡改风险，可能被植入垃圾广告甚至是病毒

3.冒充风险，比如冒充淘宝网站，用户容易上当受骗

**于是HTTPS在HTTP（应用层）和TCP（传输层中间）加入了TLS协议，来解决上述风险**

TLS为什么能保证安全？：

1.信息加密：HTTP交互内容是被加密的，第三方就无法窃取

2.校验机制：校验信息传输过程中是否被第三方篡改过，如果有，那么会出现警告提示

3.身份证书：CA证书能够证明访问的网站的可证实性

### 密钥交换算法：不同的密钥算法TLS的握手过程也是有区别的

考虑到性能问题，所以双方在加密应用信息时使用的是对称加密密钥，而对称机密密钥是不能被泄露的，为了保证对称加密密钥的安全性，所以**使用非对称加密密钥的方式来保护对称加密密钥协**的协商，这个就是密钥交换算法负责的区域。



#### RSA握手过程：

传统的TLS握手基本都是使用RSA算法来实现的，在TLS证书部署服务器时，证书中包含一对公私钥，其中公钥会在TLS握手阶段传递给客户端，私钥则一直留在服务端，一定要确保私钥不能被窃取。

**在RSA密钥协商算法中，客户端会生成随机密钥，并使用服务端的公钥加密后再传给服务端。然后可以用私钥来解开公钥加密的消息，这样服务器解密之后双方就得到了相同的密钥，然后再用它加密应用消息。**

### 证书里面装了公钥

### 过程：

（第一次握手）客户端向服务端发送 客户端随机数C、客户端TLS版本号、 能够支持的密码套件列表 

（第二次握手）服务端确认收到客户端的消息 确认TLS版本号以及随机数C以及确认套件码，然后向客户端发送ACK、 服务器随机数S、 以及证书（含有公钥）

（第三次握手）客户端收到证书取出其中的公钥，然后通过公钥（客户端随机数C+服务端随机数S+pre-master）进行加密，然后计算出会话密钥。然后客户端向服务器发送通过公钥加密的premaster 

（第四次握手）服务器端收到这个premaster，然后用自己独有的私钥来对这个premaster进行一个解密得到会话密钥。

之后的交流中，两端都使用这个会话密钥进行加密通信。

## RSA算法加密和解密：

```js
公钥 (E,N)  私钥(D,N)
明文^E % N =密文 ；
密文^D % N =明文 ； 
加密的过程是可逆的
```

### 公钥和私钥生成:

1.选择两个质数

比如p=3; q=11;

2.质数相乘

N = p* q = 3* 11 =33;

3.欧拉函数

T = （p-1）*(q-1)=2 *10 = 20

4.选择公钥E

公钥一定要是质数； 1< 公钥 < T ;不是T的因子  E（3,33）;

5、算私钥D

(D*E)%T =1  D=（7，33）；



### pre-master也是一个随机数

### 最终的会话密匙  =  客户端随机数 + 服务器随机数 + 公钥



![image-20211210155925356](C:\Users\11791\AppData\Roaming\Typora\typora-user-images\image-20211210155925356.png)

**密码套件**看起来很头晕，但是是有固定格式和规范的，基本形式是｛密钥交换算法+签名算法+对称加密算法+摘要算法｝

这里可以看到选择的密码套件， with 前面的第一个单词 是密钥交换算法  第二个单词是约定证书的约定算法。比如上面这组密码套件的意思就是：

由于With单词前面单词只有一个RSA，说明握手的密钥交换算法和签名算法都是用的RSA

握手后的通信使用的AES算法，密钥长度是128位，分组模式是GCM

摘要算法是SHA384用于消息认证和产生随机数



## HTTPS优化：

由于HTTP裸数据传输，而HTTPS就相当于给应用数据套了个保护伞，提高安全性的同时也带来了性能消耗。

因为HTTPS相比HTTP多了一个TLS握手过程，目的是通过费对称加密携手得到对称加密密钥，这个过程最多能花掉2RTT

#### 产生性能消耗的环节：TLS握手过程  握手后的加密报文传输

### 1.硬件优化：

计算机中的一切都跑在物理硬件上面，所以要优化HTTPS可以考虑更好的硬件设施，HTTPS协议是计算密集形，而不是I\O行，所以应该把钱花在CPU上。

### 2.软件优化：

1.软件优化包括对操作系统等等的优化

2.协议优化：对密钥交换过程进行优化

TLS1.2版本中如果使用的是RSA密钥交换算法，那么需要四次握手而且花费时间2RTT才能对数据进行传输。

总之，使用RSA密钥交换算法握手过程不仅仅慢，而且安全性也不高

因此如果可以，尽量选择用ECDHE密钥交换算法来替换RSA，因为该算法支持False Start ，意思是抢跑，客户端可以在TLS协议的第三次握手之后，第四次握手之前发送加密的应用数据，一次将TLS握手的消息往返由2RTT减少到了1RTT，而且安全性也高。

### TLS升级：

TLS1.3大幅度优化了握手的步骤，完成TLS握手只需要1RTT

1.客户端在ClientHello消息中带上了支持椭圆曲线以及这些曲线对应的公钥

2.服务端收到后选定一个椭圆曲线等参数，然后返回消息时，带上服务端这边的公钥。经过这一个RTT双方手上已经有生成会话密钥的材料，于是计算出会话密匙就可以进行加密传输了。



此外TLS1.3还对密码套件进行了减肥：

对于密钥交换算法废除了不支持前向安全性的RSA和DH算法，只支持ECDHE算法。

### 证书优化：1.证书传输2.证书验证

1.传输优化，减少证书大小对于服务器的证书选择椭圆曲线证书，而不是RSA证书，因为同样安全强度下,ECC密钥长度比RSA短得多。

2.证书验证优化  客户端在验证证书过程是一个比较复杂的过程，因为证书链会逐级验证。



### CRL证书吊销列表：是CA定期更新的，如果被撤销信任的证书序号如服务器的证书在此列表，就认为证书已经失效

