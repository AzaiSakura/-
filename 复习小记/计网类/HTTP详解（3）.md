## HTTP详解（3）

<img src="C:\Users\11791\AppData\Roaming\Typora\typora-user-images\image-20211214092424713.png" alt="image-20211214092424713" style="zoom:50%;" />

### HTTP3的强势来袭

### HTTP2的美中不足：

http2通过 **头部压缩、二进制编码、多路复用、服务器推送**等新特性大幅度提升了HTTP1.1的性能，而美中不足的是HTTP2协议是基于TCP实现的，于是存在的缺陷有三个。

**1.队头阻塞**

**2.TCP与TLS的握手延迟**

**3.网络迁移需要重新连接**

#### 1.队头阻塞：

HTTP2多个请求在同一个TCP连接中，那么当TCP丢包时，整个数据流都要等待重传，于是就会阻塞该TCP连接中的所有请求。TCP是字节流协议，TCP层必须保证收到的字节数据是完整且有序的，如果序列号较低的TCP段的网络传输中丢失了，即使序列号较高的TCP段已经被接收了，应用层也无法从内核中读取到这部分数据，从HTTP视角看，请求就是被阻塞了。

#### 2.TCP与TLS的握手时延迟

发起HTTP请求时，需要经过TCP三次握手和TLS四次握手（TLS1.2）因此，共需要3个RTT的时延才能发送请求

TCP由于具有**拥塞控制**的特性所以刚建立的TCP会有个慢启动的过程，它会对TCP连接产生减速效果。

#### 3.网络迁移需要重新链接，一个TCP由四元组确定（源IP地址，源端口，目标IP地址，目标端口）确定，这意味着如果IP地址或者端口变动了，就会导致TCP与TLS重新握手，这不利于移动设备切换网络的场景，比如4G网络环境切换成WIFI。



这些都是TCP协议固有的问题，无论应用层的HTTP2如何设计都无法逃脱，于是HTTP3中就把TCP换成了UDP



<img src="C:\Users\11791\AppData\Roaming\Typora\typora-user-images\image-20211214094849838.png" alt="image-20211214094849838" style="zoom:50%;" />

## QUIC协议特点

我们知道UDP是一个简单、不可靠的传输协议，而且UDP包之间是无序的，也没有依赖关系。

而且UDP不需要连接，这就意味着没有握手过程，自然比TCP更快

与此同时，HTTP3在不仅仅把TCP换成了UDP还基于UDP协议在应用层实现了QUIC协议，它具有类似TCP的连接管理，拥塞窗口，流量控制的网络特性，相当于把不可靠的UDP换成了可靠的了。

#### QUIC的优点：

1.无队头阻塞 2. 更快连接建立 3.连接迁移

### 无队头阻塞：

QUIC协议也有类似HTTP/2 Stream与多路复用的概念，也是可以在同一条连接上传输多个Stream，Stream可以认为就是一条HTTP请求。

由于QUIC使用的传输协议是UDP，UDP不关心数据包的顺序，如果数据包丢失，UDP也不关心。

不过QUIC协议会保证数据包的可靠性，每个数据包有一个序号唯一标识。当某个流中的数据包丢失了，即使该流的其他数据包到了也无法被HTTP3读取，直到QUIC重传丢失的报文数据才会交给HTTP3

而其他流的报文只要被完整接受HTTP3就可以读取到数据。

QUIC连接上的多个流 之间是没有依赖的是独立的，某个流发生了丢包，只会影响该流不会影响其他流。

### 更快建立链接：

对于HTTP1和HTTP2，TCP与TLS是分层的，分别属于内核实现的传输层和openssl库实现的表示层，因此他们难以合并在一起，需要分批次来握手，TCP先握手，TLS在握手

HTTP3在传输数据之前虽然需要QUIC协议握手，这个握手过程只需要1RTT，握手的目的是为确认双方的连接ID，连接迁移就是基于ID实现的。

但是HTTP3的QUIC协议并不是与TLS分层，而是**QUIC内部包含了TLS，他在自己的帧会携带TLS里面的记录，在加上QUIC使用的是TLS1.3因此只需要1个RTT就可以同时完成建立与密钥协商，甚至在第二次连接的时候，应用数据包可以和QUIC握手（连接信息+TLS信息）一起发送，达到0-RTT的效果，**

### 连接迁移：

前面有说道基于TCP的HTTP协议是通过四元组确定一条TCP连接，那么当从移动设备的4G切换为WIFI的时候意味着IP地址变化了，那么就必须要切开连接然后从新建立连接，而建立连接就会重新握手，以及TCP慢启动的减速过程，因此连接迁移的成本是很高的。

QUIC没有通过四元组的方式来绑定链接，而是通过**连接ID**来标记通信的两个端点，客户端和服务器可以各自选择一组ID来标记自己，因此即使移动设备的网络变化后，导致IP地址变化了，只要仍保有上下文信息（比如连接ID、TLS密钥）就可以无缝地复用原链接，消除了连接成本，没有丝毫卡顿，达到了连接迁移的功能。



## HTTP3协议：

了解完毕了QUIC协议的特点后，我们再来看看HTTP3协议在HTTP这一层做了什么优化。

HTTP3同HTTP2一样采用了二进制帧的结构不同的地方在于HTTP2的二进制帧里需要定义Stream，而HTTP3自身不需要在定义Stream，直接使用QUIC里面的Stream，于是HTTP3的帧的结构也变得简单了。

![image-20211214105936397](C:\Users\11791\AppData\Roaming\Typora\typora-user-images\image-20211214105936397.png)

HTTP3的帧头只有两个字段：类型和长度。

根据帧类型的不同，大体上分为数据帧和控制帧这两大类，HTTP头部帧和DATA帧属于数据帧

HTTP3在头部压缩算法这一方面也做了升级，升级成了QPACK，在与HTTP2中的HPACK编码方式相似，HTTP3中的QPACK也采用了静态表、动态表以及Huffman编码。

对于静态表的变化只有61项，而HTTP3中的QPACK扩大到了91项。

HTTP2和HTTP3的哈夫曼编码并没有多大不同，但是动态表编解析码的方式不同。

所谓的动态表，就是在首次请求-响应后，双方会将未包含在静态表中的Header项更新各自的动态表，接着后续传输时候仅用一个数字表示，然后对方就可以通过这一个数字从动态表查到对应的数据，就不必每次都传输长长的数据，大大提升了编码效率。

可以看出动态表是具有时序性的，如果首次出现的请求发生了丢包，后续的收到请求，对方就无法解码出HPACK头部，因为对方还没建立好动态表，因此后续的请求解码会阻塞到首次请求中丢失的数据包重传过来，

而HTTP3中的QPACK解决了这个问题，QUIC会有两个特殊的单向流，所谓的单向流只有一端可以发送消息，双向则指两端都可以发送消息，传输HTTP消息时就用的是双向流，这两个单向流的用法：

一个叫QPACK Encoder Stream 用于将一个字典（键值对）传递给对方，比如面对不属于静态表的HTTP请求头部，客户端可以通过Stream发送字典。

一个叫QPACK Decoder Stream 用于响应对方，告诉它刚发的字典已经更新到自己的本帝动态表了，后续就可以使用这个字典来编码。

这两个特护的单向流是用来同步对方的动态表，编码方收到解码方更新确定的通知后，才使用动态编码HTTP头部。

